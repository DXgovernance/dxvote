name: IPFS Deploy

on:
  workflow_run:
    workflows: ["Code Build"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.17.6]
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: build-artifact

      - name: Deploy to IPFS
        uses: web3-storage/add-to-web3@v1
        id: web3
        with:
          web3_token: ${{ secrets.WEB3_STORAGE_TOKEN }}
          path_to_add: 'build'
 
      - name: Update DNS record for Develop branch
        run: npx dnslink-cloudflare --domain dxvote.dev --record _dnslink.develop --link /ipfs/${{ steps.web3.outputs.cid }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        if: github.ref == 'refs/heads/develop'

      - name: Update DNS record for Master branch
        run: npx dnslink-cloudflare --domain dxvote.dev --record _dnslink --link /ipfs/${{ steps.web3.outputs.cid }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        if: github.ref == 'refs/heads/master'
